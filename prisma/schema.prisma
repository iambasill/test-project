// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

enum UserStatus {
    PENDING
    ACTIVE
    SUSPENDED
}

enum InspectionStatus {
    S
    O
    A
    B
    C
}

enum UserRole {
    PLATADMIN
    ADMIN
    MANAGER
    AUDITOR
    OFFICER
}

enum AcquisitionMethod {
    PURCHASE
    LEASE
    DONATION
    TRANSFER
    OTHER
}


model equipmentCategory {
    id                    String                 @id @default(uuid())
    name                  String
    createdAt             DateTime               @default(now())
}


model User {
    id                    String                 @id @default(uuid())
    email                 String                 @unique
    firstName             String
    lastName              String
    serviceNumber         String?                @unique
    rank                  String?
    unit                  String?
    role                  UserRole?
    status                UserStatus?           @default(PENDING)            
    password              String
    isActive              Boolean                @default(false)
    refreshToken          String?
    resetToken            String?
    resetTokenExpiry      DateTime?
    loginAttempt          Int? @default(0)
    lastLogin             DateTime?
    createdAt             DateTime               @default(now())
    updatedAt             DateTime               @updatedAt
    inspections           Inspection[]
    conditionRecords      EquipmentCondition[]
    User_sessions         User_sessions[]
    Active_admin_sessions Active_admin_sessions?
    EquipmentOwnership    EquipmentOwnership[]

    @@map("users")
}

model Equipment {
    id           String @id @unique @default(uuid())
    chasisNumber String @unique // Now using chasisNumber as primary key

    // Section A: Equipment Identification
    equipmentName     String
    model             String
    equipmentType     String
    equipmentCategory String?
    manufacturer      String
    modelNumber       String?
    yearOfManufacture String?
    countryOfOrigin   String

    // Section B: Acquisition Details
    dateOfAcquisition   String?
    acquisitionMethod   AcquisitionMethod
    supplierInfo        String?
    purchaseOrderNumber String?
    contractReference   String?
    costValue           String?
    currency            String            @default("NGN")
    fundingSource       String?
    warrantyStartDate String?
    warrantyEndDate String?
    warrantyCoverageDetails String?




    // Section C: Technical Specifications
    weight                  String?
    dimensions              String?
    powerRequirements       String?
    fuelType                String?
    maximumRange            String?
    operationalSpecs        String? @db.Text
    requiredCertifications  String? @db.Text
    environmentalConditions String? @db.Text

    // Condition Tracking
    currentCondition   String?
    lastConditionCheck String?
    idempotency_tracker  Idempotency_tracker[]


    // Relations
    ownerships       EquipmentOwnership[]
    documents        Document[]
    inspections      Inspection[]
    operators        Operator[]
    conditionHistory EquipmentCondition[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("equipments")
}

model Operator {
    id                    String  @id @default(uuid())
    email                 String @unique
    firstName             String
    lastName              String
    serviceNumber         String @unique
    rank                  String
    branch                String?
    position              String?
    identificationType    String?
    identificationId      String? @unique
    officialEmailAddress  String?
    phoneNumber           String?
    alternatePhoneNumber1 String?
    alternatePhoneNumber2 String?
    alternatePhoneNumber3 String?

    // Relations
    documents             Document[]
    ownerships            EquipmentOwnership[]
    equipment             Equipment?           @relation(fields: [equipmentChasisNumber], references: [chasisNumber])
    equipmentChasisNumber String? // Changed from equipmentId to equipmentChasisNumber

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("operators")
}

model EquipmentOwnership {
    id              String    @id @default(uuid())
    equipment       Equipment @relation(fields: [equipmentId], references: [id])
    equipmentId     String
    operator        Operator  @relation(fields: [operatorId], references: [id])
    operatorId      String
    startDate       DateTime  @default(now())
    endDate         DateTime?
    isCurrent       Boolean   @default(true)
    primaryDuties   String?
    driverLicenseId String?

    // Comander information
    coFirstName   String?
    coLastName    String?
    coEmail       String?
    coPhoneNumber String?

    // Equipment condition at assignment
    conditionAtAssignment String? @default("")
    notes                 String?
    documents             Document[]
    idempotency_tracker Idempotency_tracker[]

    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    userId     String
    assignedBy User     @relation(fields: [userId], references: [id])

    @@index([equipmentId])
    @@index([operatorId])
    @@index([createdAt])
    @@index([isCurrent])
    @@map("equipment_ownerships")
}

model EquipmentCondition {
    id                    String          @id @default(uuid())
    equipment             Equipment       @relation(fields: [equipmentChasisNumber], references: [chasisNumber])
    equipmentChasisNumber String
    condition             String
    date                  DateTime        @default(now())
    notes                 String?
    recordedBy            User?           @relation(fields: [recordedById], references: [id])
    recordedById          String?
    inspectionId          String?
    documents             Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("equipment_conditions")
}

// Main Inspection Model - One comprehensive inspection per session
model Inspection {
  id               String   @id @default(uuid())
  equipmentId      String
  inspectorId      String?
//   templateId       String?  // Link to template if this inspection was created from one
  datePerformed    DateTime @default(now())
  nextDueDate      DateTime?
  overallNotes     String?  @db.Text
  overallCondition          InspectionStatus @default(S)
  
  // Relations
  equipment Equipment? @relation(fields: [equipmentId], references: [id])
  inspector User?      @relation(fields: [inspectorId], references: [id])
//   template  InspectionTemplate? @relation(fields: [templateId], references: [id])
  
  // All inspection items in one table
  items InspectionItem[]
  
  // Documents
  documents Document[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  idempotency_tracker  Idempotency_tracker[]

  @@map("inspections")
}


// Unified Inspection Items - actual inspection data
model InspectionItem {
  id           String   @id @default(uuid())
  inspectionId String
  
  // Item identification
  category     String   // engine, steering, brakes, etc.
  itemName     String
  itemType     String   // condition, measurement, boolean, text
  position     String?  // Front-L, Rear-R, etc.
  
  // Inspection data
  condition    String?  // Good, Fair, Poor, etc.
  pressure  String?  // For tires
  value        String?  // For measurements
  booleanValue Boolean? // For yes/no checks
  unit         String?  // psi, mm, etc.
  stumpLastDate DateTime? // For items that need regular replacement
  oilfilterLastDate DateTime? // For items that need regular replacement
  fuelpumpLastDate DateTime? // For items that need regular replacement
  airfilterLastDate DateTime? // For items that need regular replacement
  HubLastPackedDate DateTime? // For items that need regular replacement
  lastDrainDate DateTime? // For items that need regular replacement
  odometerReading String? // For vehicle inspections
  levelOfHydraulicFluid String? // For hydraulic systems
  notes        String?  @db.Text
  
  
  inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
    // templateItem InspectionTemplateItem? @relation(fields: [templateItemId], references: [id])  
  // Documents specific to this inspection item
  documents Document[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([inspectionId, category])
  @@map("inspection_items")
}


model Document {
    id                 String    @id @default(uuid())
    fileName           String
    fileType           String?
    fileSize           Int?
    fileUrl            String
    equipmentId       String?
    equipment         Equipment? @relation(fields: [equipmentId], references: [id])
    operatorId        String?
    operator          Operator?  @relation(fields: [operatorId], references: [id])
    ownershipId      String?
    ownership        EquipmentOwnership? @relation(fields: [ownershipId], references: [id])
    conditionRecordId String?
    conditionRecord   EquipmentCondition? @relation(fields: [conditionRecordId], references: [id])
    inspectionId     String?
    inspection       Inspection? @relation(fields: [inspectionId], references: [id])
    inspectionItemId String?
    inspectionItem   InspectionItem? @relation(fields: [inspectionItemId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("documents")
}

model Active_admin_sessions {
    id          String    @id @default(cuid())
    admin_id    String    @unique
    login_time  DateTime
    logout_time DateTime?
    user        User?     @relation(fields: [admin_id], references: [id], onDelete: Cascade)

    @@map("Active_admin_sessions")
}

model User_sessions {
    id            String    @id @default(cuid())
    user_id       String
    session_token String?
    refreshToken String @default("")
    login_time    DateTime  @default(now())
    logout_time   DateTime?
    user          User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

    @@map("user_sessions")
}

model Idempotency_tracker {
    id              String    @id @default(cuid())
    key             String
    equipment_id    String?
    inspection_id   String?
    equipment_ownership_id String?

    equipment Equipment?    @relation(fields: [equipment_id], references: [id], onDelete: Cascade)
    inspection Inspection?  @relation(fields: [inspection_id], references: [id], onDelete: Cascade)
    equipment_ownership EquipmentOwnership?  @relation(fields: [equipment_ownership_id], references: [id], onDelete: Cascade)



    @@index([key])
    @@map("idempotency-tracker")

}
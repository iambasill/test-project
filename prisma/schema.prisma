// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "mysql"
    url      = env("DATABASE_URL")
}

enum UserStatus {
    PENDING
    ACTIVE
    SUSPENDED
    DELETED
}

enum UserRole {
    SYSADMIN
    ADMIN
    MANAGER
    AUDITOR
    OFFICER
}

enum ConditionStatus {
    EXCELLENT
    GOOD
    FAIR
    POOR
    FAILED
    NOT_APPLICABLE
}

enum AcquisitionMethod {
    PURCHASE
    LEASE
    DONATION
    TRANSFER
    OTHER
}

model User {
    id               String               @id @default(uuid())
    email            String               @unique
    firstName        String
    lastName         String
    serviceNumber    String?              @unique
    rank             String?
    unit             String?
    role             UserRole?
    status           UserStatus           @default(PENDING)
    password         String
    refreshToken     String?
    resetToken       String?
    resetTokenExpiry DateTime?
    lastLogin        DateTime?
    createdAt        DateTime             @default(now())
    updatedAt        DateTime             @updatedAt
    inspections      Inspection[]
    conditionRecords EquipmentCondition[]

    @@map("users")
}

model Equipment {
    id           String @id @default(uuid())
    chasisNumber String @unique // Now using chasisNumber as primary key

    // Section A: Equipment Identification
    equipmentName     String
    model             String
    equipmentType     String
    equipmentCategory String?
    manufacturer      String
    modelNumber       String?
    yearOfManufacture String?
    countryOfOrigin   String

    // Section B: Acquisition Details
    dateOfAcquisition   String?
    acquisitionMethod   AcquisitionMethod
    supplierInfo        String?
    purchaseOrderNumber String?
    contractReference   String?
    costValue           String?
    currency            String            @default("NGN")
    fundingSource       String?

    // Section C: Technical Specifications
    weight                  String?
    dimensions              String?
    powerRequirements       String?
    fuelType                String?
    maximumRange            String?
    operationalSpecs        String? @db.Text
    requiredCertifications  String? @db.Text
    environmentalConditions String? @db.Text

    // Condition Tracking
    currentCondition   String?
    lastConditionCheck String?

    // Relations
    ownerships       EquipmentOwnership[]
    documents        Document[]
    inspections      Inspection[]
    operators        Operator[]
    conditionHistory EquipmentCondition[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("equipments")
}

model Operator {
    id                    String  @id @default(uuid())
    email                 String? @unique
    firstName             String
    lastName              String
    serviceNumber         String? @unique
    rank                  String?
    branch                String?
    position              String?
    identificationType    String?
    identificationId      String? @unique
    officialEmailAddress  String?
    phoneNumber           String?
    alternatePhoneNumber1 String?
    alternatePhoneNumber2 String?
    alternatePhoneNumber3 String?

    // Relations
    documents             Document[]
    ownerships            EquipmentOwnership[]
    equipment             Equipment?           @relation(fields: [equipmentChasisNumber], references: [chasisNumber])
    equipmentChasisNumber String? // Changed from equipmentId to equipmentChasisNumber

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("operators")
}

model EquipmentOwnership {
    id                    String    @id @default(uuid())
    equipment             Equipment @relation(fields: [equipmentChasisNumber], references: [chasisNumber])
    equipmentChasisNumber String // Changed from equipmentId
    operator              Operator  @relation(fields: [operatorId], references: [id])
    operatorId            String
    startDate             DateTime  @default(now())
    endDate               DateTime?
    isCurrent             Boolean   @default(true)
    primaryDuties         String?
    driverLicenseId       String?

    // Comander information
    coFirstName   String?
    coLastName    String?
    coEmail       String?
    coPhoneNumber String?

    // Equipment condition at assignment
    conditionAtAssignment ConditionStatus @default(EXCELLENT)
    notes                 String?
    documents             Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([equipmentChasisNumber, operatorId, isCurrent])
    @@map("equipment_ownerships")
}

model EquipmentCondition {
    id                    String          @id @default(uuid())
    equipment             Equipment       @relation(fields: [equipmentChasisNumber], references: [chasisNumber])
    equipmentChasisNumber String
    condition             ConditionStatus
    date                  DateTime        @default(now())
    notes                 String?
    recordedBy            User?           @relation(fields: [recordedById], references: [id])
    recordedById          String?
    inspectionId          String?
    documents             Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("equipment_conditions")
}

// Main Inspection Model - One comprehensive inspection per session
model Inspection {
    id            String    @id @default(uuid())
    equipmentId   String
    inspectorId   String?
    datePerformed DateTime  @default(now())
    nextDueDate   DateTime?
    overallNotes  String?   @db.Text

    // Relations
    equipment Equipment? @relation(fields: [equipmentId], references: [id])
    inspector User?      @relation(fields: [inspectorId], references: [id])

    // Inspection Categories - All part of one comprehensive inspection
    exteriorInspections      ExteriorInspection[]
    interiorInspections      InteriorInspection[]
    mechanicalInspections    MechanicalInspection[]
    functionalInspections    FunctionalInspection[]
    documentLegalInspections DocumentLegalInspection[]

    // General documents for the inspection
    documents Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("inspections")
}

model ExteriorInspection {
    id           String          @id @default(uuid())
    inspectionId String
    itemName     String // e.g., "Body Paint", "Tires", "Windshield"
    condition    ConditionStatus
    notes        String?         @db.Text

    inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
    documents  Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("exterior_inspections")
}

model InteriorInspection {
    id           String          @id @default(uuid())
    inspectionId String
    itemName     String // e.g., "Seats", "Dashboard", "Controls"
    condition    ConditionStatus
    notes        String?         @db.Text

    inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
    documents  Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("interior_inspections")
}

model MechanicalInspection {
    id           String          @id @default(uuid())
    inspectionId String
    itemName     String // e.g., "Engine", "Brakes", "Transmission"
    condition    ConditionStatus
    notes        String?         @db.Text

    inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
    documents  Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("mechanical_inspections")
}

model FunctionalInspection {
    id           String          @id @default(uuid())
    inspectionId String
    itemName     String // e.g., "Radio", "GPS", "Air Conditioning"
    condition    ConditionStatus
    notes        String?         @db.Text

    inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
    documents  Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("functional_inspections")
}

model DocumentLegalInspection {
    id           String          @id @default(uuid())
    inspectionId String
    itemName     String // e.g., "Registration", "Insurance", "License"
    condition    ConditionStatus
    notes        String?         @db.Text

    inspection Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
    documents  Document[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("document_legal_inspections")
}

model Document {
    id          String  @id @default(uuid())
    url         String
    description String?
    metadata    Json?
    fileName    String?
    fileSize    Int?
    mimeType    String?

    // Relations - A document can belong to multiple entities
    equipment    Equipment?          @relation(fields: [equipmentId], references: [id])
    equipmentId  String?
    operator     Operator?           @relation(fields: [operatorId], references: [id])
    operatorId   String?
    inspection   Inspection?         @relation(fields: [inspectionId], references: [id])
    inspectionId String?
    ownership    EquipmentOwnership? @relation(fields: [ownershipId], references: [id])
    ownershipId  String?
    condition    EquipmentCondition? @relation(fields: [conditionId], references: [id])
    conditionId  String?

    // Relations to specific inspection categories
    exteriorInspectionId      String?
    interiorInspectionId      String?
    mechanicalInspectionId    String?
    functionalInspectionId    String?
    documentLegalInspectionId String?

    exteriorInspection      ExteriorInspection?      @relation(fields: [exteriorInspectionId], references: [id])
    interiorInspection      InteriorInspection?      @relation(fields: [interiorInspectionId], references: [id])
    mechanicalInspection    MechanicalInspection?    @relation(fields: [mechanicalInspectionId], references: [id])
    functionalInspection    FunctionalInspection?    @relation(fields: [functionalInspectionId], references: [id])
    documentLegalInspection DocumentLegalInspection? @relation(fields: [documentLegalInspectionId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("documents")
}
